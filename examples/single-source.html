<!doctype html>
<html lang="en">
    <head>
        <title>Binaural Panner Single Source</title>
        <meta charset="utf-8"/>
        <script src="../include/AudioContextMonkeyPatch.js"></script>
        <script src="../binaural.js"></script>
        <script src="./js/jquery-1.11.1.min.js"></script>
        <script src="./js/jquery.knob.js"></script>
        <style type="text/css">
         .warning,.stop
         {
             background-color: rgba(255, 0, 0, 0.7);
         }

         .play
         {
             background-color: rgba(0, 255, 0, 0.5);
         }

         .control
         {
             font-size: 2em;
         }

         input[type=range][orient=vertical]
         {
             writing-mode: bt-lr; /* IE */
             -webkit-appearance: slider-vertical; /* WebKit */
             width: 8px;
             height: 175px;
             padding: 0 5px;
         }
        </style>
    </head>
    <body>
        <h1>Binaural Panner Single Source</h1>

        <p>This example illustrates the use of the
          <a href="https://github.com/Ircam-RnD/binauralFIR/tree/next">BinauralPanner</a>
        to spatialize in real-time an incoming monophonic audio stream
          around the head of the listener.</p>

        <p>Other examples are <a href="index.html">here</a>.</p>

        <button id="player-control" class="control stop">Play</button>

        <select id="hrtf-set"></select>
        <div id="sample-rate-warning" class="warning"></div>

        <center>
            <table>
                <tr>
                    <th> Azimuth  (deg) </th>
                    <th> Elevation (deg) </th>
                    <th> Distance  (mm) </th>
                </tr>
                <tr>
                    <td>
                        <input id="azimuth" type="text" data-angleOffset=180 class="vs1" data-width="180" data-cursor=true data-thickness=".5" data-min="-180" data-max="180" data-rotation="clockwise" />
                    </td>
                    <td>
                        <input id="elevation" type="text" value="0" class="dial" data-width="180" data-min="-90" data-max="90" data-cursor=true data-rotation="clockwise" data-angleArc="180" data-angleOffset="180" />
                    </td>
                    <td>
                        <input id="distance" type="text" value="0.1" class="dial" data-width="180" data-step="1" data-min="200" data-max="10000" data-cursor=true data-rotation="clockwise" data-angleArc="180" data-angleOffset="180" />
                    </td>
                </tr>
            </table>
        </center>

        <script>
         /* global binaural, $ */

         var audioContext = new AudioContext();
         var serverDataBase = new binaural.sofa.ServerDataBase();

         // Audio Nodes
         var binauralPanner = new binaural.audio.BinauralPanner({
             audioContext: audioContext,
             crossfadeDuration: 0.05, // in seconds
             coordinateSystem: 'spat4Spherical', // [azimuth, elevation, distance]
             sourceCount: 1,
             sourcePositions: [ [0, 0, 1] ], // initial position
             distAttenuationExponent: 1,
         });
         binauralPanner.connectOutputs(audioContext.destination);

         // player
         var playerBuffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
         var player = audioContext.createBufferSource();
         player.buffer = playerBuffer;

         var $playerControl = document.querySelector('#player-control');
         $playerControl.onclick
             = $playerControl.ontouchstart = function(event) {
                 event.preventDefault(); // do not click after touch
                 $playerControl.classList.toggle('play');
                 $playerControl.classList.toggle('stop');
                 if ($playerControl.classList.contains('play') ) {
                     $playerControl.textContent = 'Stop';
                     playerStart();
                 } else if ($playerControl.classList.contains('stop') ) {
                     $playerControl.textContent = 'Play';
                     playerStop();
                 }
             };

         function playerStart() {
             player = audioContext.createBufferSource();
             player.buffer = playerBuffer;
             player.loop = true;
             binauralPanner.connectInputByIndex(0, player);
             player.start(0);
         }

         function playerStop() {
             player.stop(0);
         }

         function getAudioData() {
             var request = new XMLHttpRequest();
             var url = './snd/breakbeat.wav';
             request.open('GET', url, true);
             request.responseType = 'arraybuffer';

             request.onload = function() {
                 var audioData = request.response;

                 audioContext.decodeAudioData(audioData, function(buffer) {
                     playerBuffer = buffer;
                     if ($playerControl.classList.contains('play') ) {
                         playerStop();
                         playerStart();
                     }

                 }, function(error) {
                     throw new Error('Error with decoding audio data' + error.message);
                 });
             };

             request.onerror = function() {
                 throw new Error('Error while loading ' + url
                               + request.status + request.responseText);
             };

             request.send();
         }
         getAudioData();

         // Knobs
         var $azimuth = $('#azimuth');
         $azimuth.val(0);
         $azimuth.knob({
             'change': function(value) {
                 // get current position
                 var position = binauralPanner.getSourcePositionByIndex(0);

                 // update azimuth
                 position[0] = value;
                 binauralPanner.setSourcePositionByIndex(0, position);

                 // update filters
                 window.requestAnimationFrame(function() {
                     binauralPanner.update();
                 });
             },
         });

         var $elevation = $('#elevation');
         $elevation.val(0);
         $elevation.knob({
             'change': function(value) {
                 // get current position
                 var position = binauralPanner.getSourcePositionByIndex(0);

                 // update value
                 position[1] = value;
                 binauralPanner.setSourcePositionByIndex(0, position);

                 // update filters
                 window.requestAnimationFrame(function() {
                     binauralPanner.update();
                 });
             },
         });

         var $distance = $('#distance');
         $distance.val(0.1);
         $distance.knob({
             'change': function(value) {
                 // get current position
                 var position = binauralPanner.getSourcePositionByIndex(0);

                 // update value
                 position[2] = value / 1000.0;
                 binauralPanner.setSourcePositionByIndex(0, position);

                 // update filters
                 window.requestAnimationFrame(function() {
                     binauralPanner.update();
                 });
             },
         });

         // HRTF set selection
         var $hrtfSet = document.querySelector('#hrtf-set');
         $hrtfSet.onchange = function() {
             loadHrtfSet($hrtfSet.value);
         };

         var $sampleRateWarning = document.querySelector('#sample-rate-warning');

         var catalogLoaded = serverDataBase.loadCatalogue();

         function clearHrtfList() {
             for (var option = $hrtfSet.options.length - 1; option >= 0; --option) {
                 $hrtfSet.options[option].remove();
             }
         }

         // local files (1147 as default in menu)
         var localUrls = [
             './hrtf/IRC_1037_C_HRIR_44100.sofa.json',
             './hrtf/IRC_1037_C_HRIR_48000.sofa.json',
             './hrtf/IRC_1076_C_HRIR_44100.sofa.json',
             './hrtf/IRC_1076_C_HRIR_48000.sofa.json',
             './hrtf/IRC_1147_C_HRIR_M_44100.sofa.json',
             './hrtf/IRC_1147_C_HRIR_M_48000.sofa.json',
         ];

         function fillHrtfList(urls) {
             clearHrtfList();
             var $option;
             urls.forEach(function(url) {
                 $option = document.createElement('option');
                 $option.textContent = url;
                 $hrtfSet.add($option);
             });
             $hrtfSet.classList.add('warning');
             var defaultUrl = urls.findIndex(function(url) {
                 return url.match('1147');
             });
             $hrtfSet.value = urls[defaultUrl];
             $hrtfSet.onchange();
         }
         fillHrtfList(localUrls);

         catalogLoaded.then(function() {
             var urls = serverDataBase.getUrls({
                 convention: 'HRIR',
                 equalisation: 'compensated',
                 sampleRate: audioContext.sampleRate,
             });

             return urls;
         })
         .catch(function(error) {
             /* eslint no-console: 0 */
             console.error('Error accessing HRTF server. ' + error.message);

             // local HRTF sets FIR sample-rates are 44100 and 48000 Hz
             var sampleRate = audioContext.sampleRate;
             if (sampleRate !== 44100 && sampleRate !== 48000) {
                 // Chrome 48 crashes on OX 10.9 at 96000 Hz
                 // Firefox and Safari seem to re-sample correctly
                 $sampleRateWarning.innerHTML
                     = 'Audio sample-rate at ' + sampleRate + ' Hz is unsupported.'
                     + 'Please use 44100 or 48000 Hz instead.'
                     + '(Trying to re-sample HRIRs.)';

                 /* eslint no-alert: 0 */
                 window.alert($sampleRateWarning.innerHTML);

                 if (sampleRate === 88200 || sampleRate === 96000) {
                     sampleRate *= 0.5;
                 } else {
                     sampleRate = 44100;
                 }
             }

             var urls = localUrls.filter(function(url) {
                 return url.match(sampleRate.toString() );
             });

             return urls;
         })
         .then(function(urls) {
             fillHrtfList(urls);
         });

         function loadHrtfSet(url) {
             // invalidate current
             $hrtfSet.classList.add('warning');
             return binauralPanner
               .loadHrtfSet(url)
               .then(function() {
                   $hrtfSet.classList.remove('warning');
               });
         }
        </script>
    </body>
</html>
