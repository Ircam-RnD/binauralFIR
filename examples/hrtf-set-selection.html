<!doctype html>
<html lang="en">
    <head>
        <title>Binaural Panner HRTF Set Selection</title>
        <meta charset="utf-8"/>
        <script src="../include/AudioContextMonkeyPatch.js"></script>
        <script src="../binaural.js"></script>
        <script src="./js/jquery-1.11.1.min.js"></script>
        <script src="./js/jquery.knob.js"></script>
        <style type="text/css">
         .warning,.stop
         {
             background-color: rgba(255, 0, 0, 0.7);
         }

         .mismatch
         {
             color: rgba(255, 0, 0, 0.7);
         }

         .play,.clear
         {
             background-color: rgba(0, 255, 0, 0.5);
         }

         .control
         {
             font-size: 2em;
         }

         input[type=range][orient=vertical]
         {
             writing-mode: bt-lr; /* IE */
             -webkit-appearance: slider-vertical; /* WebKit */
             width: 8px;
             height: 175px;
             padding: 0 5px;
         }
        </style>
    </head>
    <body>
        <h1>Binaural Panner HRTF Set Selection</h1>

        <p>This example illustrates the use of the
          <a href="https://github.com/Ircam-RnD/binauralFIR/tree/next">BinauralPanner</a>
        to load a given set of HRTF.</p>

        <p>Other examples are <a href="index.html">here</a>.</p>

        <p>
            All the filters apply at the same time. You can select one or
            more field, or unselect them all to avoid applying a particular
            filter. Note that loading an HRTF set with a sample-rate that
            is different from your browser may crash it.
        </p>

        <p>
            <div id="server-warning" class="warning"></div>
            Restrict HRTF by
            <label>Data-Base: <select id="filter-data-base" multiple="true"></select></label>
            <label>Equalisation: <select id="filter-equalisation" multiple="true"></select></label>
            <label>Sample-Rate: <select id="filter-sample-rate" multiple="true"></select></label>
        </p>

        <p>
            In combination with the other filters, you can also use free
            patterns, that match anywhere in the URL. The upper and
            lower-case are ignored. Use spaces to combine multiple patterns
            (as logical AND). Use '|' for logical OR. Examples:
            <pre class="free-pattern">1147</pre>
            <pre class="free-pattern">listen 44100|4800</pre>
            <pre class="free-pattern">bili|listen 44100|48000 compensated</pre>

            <label>Free Pattern: <input id="filter-free-pattern" type="text"></input></label>
        </p>

        <p>
            Please remember than all the filters apply at the same time:
            clear them when they are not needed.
            <button id="clear-filters" class="clear">Click here to clear all filters</button>
        </p>

        <label>Load an HRTF set from the selection: <select id="hrtf-set"></select></label>
        <div id="sample-rate-warning" class="warning"></div>
        <label>Use local files instead of the selection: <input accept="application/json" id="hrtf-set-local" multiple="true" type="file"></label>

        <center>
            <button id="player-control" class="control stop">Play</button>
            <pre> Azimuth </pre> <input id="azimuth" type="text"
            data-angleOffset=180 class="vs1" data-width="180"
            data-cursor=true data-thickness=".5" data-min="-180"
            data-max="180" data-rotation="clockwise" />
            <pre> Elevation </pre> <input id="elevation" type="range"
            min="-90" max="90" step="0.5" class="vs3" orient="vertical" />
        </center>

        <script>
         /* global binaural, $ */

         var audioContext = new AudioContext();
         var serverDataBase = new binaural.sofa.ServerDataBase();

         // Audio Nodes
         var binauralPanner = new binaural.audio.BinauralPanner({
             audioContext: audioContext,
             crossfadeDuration: 0.05, // in seconds
             coordinateSystem: 'spat4Spherical', // [azimuth, elevation, distance]
             sourceCount: 1,
             sourcePositions: [ [0, 0, 1] ], // initial position
         });
         binauralPanner.connectOutputs(audioContext.destination);

         var $serverWarning = document.querySelector('#server-warning');
         var $sampleRateWarning = document.querySelector('#sample-rate-warning');

         // player
         var playerBuffer = audioContext.createBuffer(1, 1, audioContext.sampleRate);
         var player = audioContext.createBufferSource();
         player.buffer = playerBuffer;

         var $playerControl = document.querySelector('#player-control');
         $playerControl.onclick
         = $playerControl.ontouchstart = function(event) {
             event.preventDefault(); // do not click after touch
             $playerControl.classList.toggle('play');
             $playerControl.classList.toggle('stop');
             if ($playerControl.classList.contains('play') ) {
                 $playerControl.textContent = 'Stop';
                 playerStart();
             } else if ($playerControl.classList.contains('stop') ) {
                 $playerControl.textContent = 'Play';
                 playerStop();
             }
         };

         function playerStart() {
             player = audioContext.createBufferSource();
             player.buffer = playerBuffer;
             player.loop = true;
             binauralPanner.connectInputByIndex(0, player);
             player.start(0);
         }

         function playerStop() {
             player.stop(0);
         }

         function getAudioData() {
             var request = new XMLHttpRequest();
             var url = './snd/breakbeat.wav';
             request.open('GET', url, true);
             request.responseType = 'arraybuffer';

             request.onload = function() {
                 var audioData = request.response;

                 audioContext.decodeAudioData(audioData, function(buffer) {
                     playerBuffer = buffer;
                     if ($playerControl.classList.contains('play') ) {
                         playerStop();
                         playerStart();
                     }

                 }, function(error) {
                     throw new Error('Error with decoding audio data' + error.message);
                 });
             };

             request.onerror = function() {
                 throw new Error('Error while loading ' + url
                               + request.status + request.responseText);
             };

             request.send();
         }
         getAudioData();

         // Knobs
         var $azimuth = $('#azimuth');
         $azimuth.val(0);
         $azimuth.knob({
             'change': function(value) {
                 // get current position
                 var position = binauralPanner.getSourcePositionByIndex(0);

                 // update azimuth
                 position[0] = value;
                 binauralPanner.setSourcePositionByIndex(0, position);

                 // update filters
                 window.requestAnimationFrame(function() {
                     binauralPanner.update();
                 });
             },
         });

         var $elevation = $('#elevation');
         $elevation.on('input', function(event) {
             // get current position
             var position = binauralPanner.getSourcePositionByIndex(0);

             // update elevation
             position[1] = event.target.value;
             binauralPanner.setSourcePositionByIndex(0, position);

             // update filters
             window.requestAnimationFrame(function() {
                 binauralPanner.update();
             });
         });

         // HRTF filters
         var filterDataBase;
         var $filterDataBase = document.querySelector('#filter-data-base');
         ['', 'BiLi', 'CIPIC', 'CrossMod', 'Listen'].forEach(function(base, index) {
             $filterDataBase.add(new window.Option(base, base) );
             $filterDataBase.size = index + 1;
         });
         $filterDataBase.onchange = function() {
             if ($filterDataBase.value === '') {
                 filterDataBase = undefined;
             } else {
                 var filters = [];
                 var options = $filterDataBase.selectedOptions;
                 for (var option = 0; option < options.length; ++option) {
                     filters.push(options[option].value);
                 }
                 filterDataBase = filters.join('|');
             }
             generateHrtfList();
         };

         var filterEqualisation;
         var $filterEqualisation = document.querySelector('#filter-equalisation');
         ['', 'Raw', 'Compensated'].forEach(function(base, index) {
             $filterEqualisation.add(new window.Option(base, base) );
             $filterEqualisation.size = index + 1;
         });
         $filterEqualisation.onchange = function() {
             if ($filterEqualisation.value === '') {
                 filterEqualisation = undefined;
             } else {
                 var filters = [];
                 var options = $filterEqualisation.selectedOptions;
                 for (var option = 0; option < options.length; ++option) {
                     filters.push(options[option].value);
                 }
                 filterEqualisation = filters.join('|');
             }
             generateHrtfList();
         };
         // default
         $filterEqualisation.value = filterEqualisation = 'Compensated';

         var filterSampleRate;
         var $filterSampleRate = document.querySelector('#filter-sample-rate');
         ['', '44100', '48000', '96000'].forEach(function(base, index) {
             var $option = new window.Option(base, base);
             $filterSampleRate.add($option);
             if (base !== '' && base !== audioContext.sampleRate.toString() ) {
                 $option.classList.add('mismatch');
             }
             $filterSampleRate.size = index + 1;
         });
         $filterSampleRate.onchange = function() {
             if ($filterSampleRate.value === '') {
                 filterSampleRate = undefined;
             } else {
                 var filters = [];
                 var options = $filterSampleRate.selectedOptions;
                 for (var option = 0; option < options.length; ++option) {
                     filters.push(options[option].value);
                 }
                 filterSampleRate = filters.join('|');
             }
             generateHrtfList();
         };
         // default
         $filterSampleRate.value = filterSampleRate = audioContext.sampleRate.toString();

         var filterFreePattern;
         var $filterFreePattern = document.querySelector('#filter-free-pattern');
         $filterFreePattern.oninput
             = $filterFreePattern.onchange = function() {
                 filterFreePattern = $filterFreePattern.value;
                 generateHrtfList();
             };
         // default
         $filterFreePattern.value = filterFreePattern = '';

         var $clearFilters = document.querySelector('#clear-filters');
         $clearFilters.onclick
             = $clearFilters.ontouchstart = function(event) {
                 event.preventDefault(); // do not click after touch
                 [
                     $filterDataBase,
                     $filterEqualisation,
                     $filterSampleRate,
                     $filterFreePattern,
                 ].forEach(function(filter) {
                     filter.value = '';
                     filter.onchange();
                 });
         };

         // HRTF set selection
         var $hrtfSet = document.querySelector('#hrtf-set');
         $hrtfSet.onchange = function() {
             loadHrtfSet($hrtfSet.value);
         };

         // trigger load on single option (it may trigger too much)
         $hrtfSet.onfocus = $hrtfSet.onclick = function(event) {
             if ($hrtfSet.options.length === 1) {
                 event.preventDefault();
                 $hrtfSet.value = $hrtfSet.options[0].value;
                 $hrtfSet.onchange();
             }
         };

         var $hrtfSetLocal = document.querySelector('#hrtf-set-local');
         $hrtfSetLocal.onchange = function() {
             clearHrtfList();

             var files = $hrtfSetLocal.files;

             for (var i = 0; i < files.length; ++i) {
                 var file = files[i];
                 var url = window.URL.createObjectURL(file);
                 var fileName = window.encodeURIComponent(file.name);
                 $hrtfSet.add(new window.Option(fileName, url) );
             }
         };

         var catalogLoaded = serverDataBase.loadCatalogue();

         function clearHrtfList() {
             for (var option = $hrtfSet.options.length - 1; option >= 0; --option) {
                 $hrtfSet.options[option].remove();
             }
         }

         // local files (1147 as default in menu)
         var localUrls = [
             './hrtf/IRC_1037_C_HRIR_44100.sofa.json',
             './hrtf/IRC_1037_C_HRIR_48000.sofa.json',
             './hrtf/IRC_1076_C_HRIR_44100.sofa.json',
             './hrtf/IRC_1076_C_HRIR_48000.sofa.json',
             './hrtf/IRC_1147_C_HRIR_M_44100.sofa.json',
             './hrtf/IRC_1147_C_HRIR_M_48000.sofa.json',
         ];

         function fillHrtfList(urls) {
             clearHrtfList();
             var $option;
             urls.forEach(function(url) {
                 $option = document.createElement('option');
                 $option.textContent = url;
                 $hrtfSet.add($option);
             });
             $hrtfSet.classList.add('warning');
         }
         fillHrtfList(localUrls);

         function generateHrtfList() {
             fillHrtfList(localUrls);
             catalogLoaded
                 .then(function() {
                     $serverWarning.innerHTML = '';
                     var urls = serverDataBase.getUrls({
                         convention: 'HRIR',
                         dataBase: filterDataBase,
                         equalisation: filterEqualisation,
                         freePattern: filterFreePattern,
                         sampleRate: filterSampleRate,
                     });

                     return urls;
                 })
                 .catch(function(error) {
                     $serverWarning.innerHTML = 'Error accessing HRTF server. '
                                                + error.message + '. '
                                              + 'Local files only.';
                     return localUrls;
                 })
                 .then(function(urls) {
                     fillHrtfList(urls);
                 });
         }
         generateHrtfList();

         function loadHrtfSet(url) {
             // invalidate current
             $hrtfSet.classList.add('warning');
             return binauralPanner
               .loadHrtfSet(url)
               .then(function() {
                   $hrtfSet.classList.remove('warning');
                   var hrtfSampleRate = binauralPanner.hrtfSet.sofaSampleRate;
                   if (audioContext.sampleRate !== hrtfSampleRate) {
                       $sampleRateWarning.innerHTML
                           = 'HRTF sample-rate (' + hrtfSampleRate + ' Hz) is different '
                           + 'from the browser sample-rate (' + audioContext.sampleRate
                           + ' Hz). Trying to re-sample the HRIRs.';
                   } else {
                       $sampleRateWarning.innerHTML = '';
                   }
               })
               .catch(function(error) {
                   /* eslint no-alert: 0 */
                   window.alert('Unable to load HRTF set from ' + url + '. '
                         + error.message);
               });
         }
        </script>
    </body>
</html>
